<div class="container">
    <h2>
        Welcome <%= user ? user.username : "User" %>
    </h2>

    <% if (blogPosts && blogPosts.length > 0) { %>
        <% blogPosts.forEach(post => { %>
            <div class="managementContainer" id="post-<%= post._id %>">
                <a href="/blog/admin/post/<%= post._id %>" class="blogContainer container">
                    <h3><%= post.title %></h3>
                    <p class="blogContent"><%= post.content %></p>
                </a>
                <div class="actionButtons adminActionButtons">
                    <button type="button"
                        onclick="window.location.href='/admin/blog/edit/<%= post._id %>'">Edit</button>
                    <button type="button" class="deleteButton" data-id="<%= post._id %>">Delete</button>
                </div>
            </div>
        <% }) %>
    <% } else { %>
        <p>No blog posts available.</p>
    <% } %>

    <div>
        <a href="/admin/blog/create">Create New Post</a>
        <button id="adminLink">Admin Invite Link</button>
    </div>
    <div id="adminLinkDisplay"></div>
</div>

<script>
    const token = localStorage.getItem("token");

    // DELETE POST
    document.querySelectorAll('.deleteButton').forEach(button => {
        button.addEventListener('click', async () => {
            const id = button.getAttribute('data-id');

            if (confirm("Do you want to delete this blog post?")) {
                try {
                    const response = await fetch(`/blog/admin/delete/${id}`, {
                        method: 'DELETE',
                        headers: {
                            "Authorization": `Bearer ${token}`
                        }
                    });

                    const data = await response.json();

                    if (response.ok) {
                        alert(data.message);
                        document.getElementById(`post-${id}`).remove();
                    } else {
                        alert(`Delete failed: ${data.message}`);
                    }
                } catch (error) {
                    alert("An unexpected error occurred");
                }
            }
        });
    });

    // GENERATE ADMIN LINK
    document.getElementById('adminLink').addEventListener("click", async () => {
        try {
            const response = await fetch(`/auth/adminToken`, {
                headers: {
                    "Authorization": `Bearer ${token}`
                }
            });

            const data = await response.json();
            if (response.ok) {
                const linkElement = document.getElementById("adminLinkDisplay");
                linkElement.innerHTML = `<a href="${data.data.inviteLink}" target="_blank">Admin Invite Link</a>`;
            } else {
                alert(data.message || "Could not generate admin link");
            }
        } catch (err) {
            console.error("Error generating link:", err);
        }
    });
</script>
